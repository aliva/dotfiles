#!/bin/bash

TIMEOUT=1

function do_action(){
    player=$1
    action=$2

    # check if player is running
    if ! pgrep $player &>/dev/null
    then
        return
    fi

    # if it wants some crappy info
    if [[ $action == "info" ]]
    then
        case $player in
            deadbeef)
                deadbeef --nowplaying '%t - %a'  2>/dev/null
                return
                ;;
            rhythmbox-client)
                rhythmbox-client print-playing-format=%tt by %ta
                return
                ;;
            clementine)
                qdbus org.mpris.clementine /Player org.freedesktop.MediaPlayer.GetMetadata \
                    | sort -r | egrep "^(title:|artist:)" | sed -e "s/^.*: //g" | sed -e ':a;N;$!ba;s/\n/ - /g'
                return
                ;;
        esac
    fi

    # MPRIS seems cool
    if [[ $player == "vlc" ]] || [[ $player == "rhythmbox" ]] || [[ $player == "clementine" ]]
    then
        case $action in
            prev)
                action="previuos"
                ;;
            play-pause)
                action="PlayPause"
                ;;
            info)
                # TODO
                return
                ;;
        esac

        action="${action^}"

        dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.$player  /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.$action
        return
    fi

    # deadbeef
    $TIMEOUT $player "--$action"
}

if [ -z $1 ]
then
    echo "[play|pause|stop|next|prev|info]"
    exit
fi

players="deadbeef clementine rhythmbox vlc"
if [ -z $2 ]
then
    for player in $players
    do
        do_action $player $1
    done
else
    do_action $1 $2
fi


