#!/bin/bash

TIMEOUT=1

function do_action(){
    player=$1
    action=$2

    if ! pgrep $player &>/dev/null
    then
        return
    fi

    if [[ $player == "rhythmbox" ]]
    then
        if [[ $action == "stop" ]]
        then
            dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.rhythmbox  /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Stop
            return
        fi
        if [[ $action == "prev" ]]
        then
            action="previous"
        fi

        player="rhythmbox-client"
    fi
    if [[ $player == "vlc" ]]
    then
        case $action in
            prev)
                action="previuos"
                ;;
            play-pause)
                action="PlayPause"
                ;;
            info)
                # TODO
                return
                ;;
        esac

        action="${action^}"

        dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.$player  /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.$action
        return
    fi

    if [[ $action == "info" ]]
    then
        case $player in
            deadbeef)
                action="--nowplaying '%t - %a'  2>/dev/null"
                ;;
            rhythmbox-client)
                action='print-playing-format=%tt by %ta'
                ;;
            clementine)
                qdbus org.mpris.clementine /Player org.freedesktop.MediaPlayer.GetMetadata \
                    | sort -r | egrep "^(title:|artist:)" | sed -e "s/^.*: //g" | sed -e ':a;N;$!ba;s/\n/ - /g'
                return
                ;;
        esac

    fi

    timeout $TIMEOUT $player "--$action"
}

if [ -z $1 ]
then
    echo "[play|pause|stop|next|prev|info]"
    exit
fi

players="deadbeef clementine rhythmbox vlc"
if [ -z $2 ]
then
    for player in $players
    do
        do_action $player $1
    done
else
    do_action $1 $2
fi


