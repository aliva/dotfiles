#!/bin/bash

TIMEOUT=1

function do_action(){
    player=$1
    action=$2

    if ! pgrep $player &>/dev/null
    then
        return
    fi

    if [[ $player == "rhythmbox" ]]
    then
        if [[ $action == "stop" ]]
        then
            dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.rhythmbox  /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Stop
            return
        fi
        player="rhythmbox-client"
    fi

    if [[ $action == "info" ]]
    then
        case $player in
            deadbeef)
                action="--nowplaying '%t - %a'  2>/dev/null"
                ;;
            rhythmbox-client)
                action="print-playing"
                ;;
            clementine)
                qdbus org.mpris.clementine /Player org.freedesktop.MediaPlayer.GetMetadata \
                    | sort -r | egrep "^(title:|artist:)" | sed -e "s/^.*: //g" | sed -e ':a;N;$!ba;s/\n/ - /g'
                return
                ;;
        esac

    fi

    timeout $TIMEOUT $player --$action
}

if [ -z $1 ]
then
    echo "[play|pause|stop|next|prev|info]"
    exit
fi

players="deadbeef clementine rhythmbox"
for player in $players
do
    do_action $player $1
done


